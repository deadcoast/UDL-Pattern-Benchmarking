name: Documentation Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'README-CTM.md'
      - 'examples/**'
      - 'udl_rating_framework/**'
      - 'scripts/check_links.py'
      - 'scripts/run_examples.py'
      - '.github/workflows/documentation-validation.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'docs/**'
      - 'README.md'
      - 'README-CTM.md'
      - 'examples/**'
      - 'udl_rating_framework/**'
      - 'scripts/check_links.py'
      - 'scripts/run_examples.py'
      - '.github/workflows/documentation-validation.yml'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  link-validation:
    name: Validate Documentation Links
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install dependencies
      run: uv sync
      
    - name: Run link validation
      id: link-check
      run: |
        uv run python scripts/check_links.py --format markdown --output link-report.md
        exit_code=$?
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        exit $exit_code
      continue-on-error: true
      
    - name: Upload link validation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: link-validation-report-${{ github.run_number }}
        path: link-report.md
        retention-days: 30
        
    - name: Comment PR with link validation results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let linkReport = '';
          try {
            linkReport = fs.readFileSync('link-report.md', 'utf8');
          } catch (error) {
            linkReport = 'Link validation report not available';
          }
          
          const exitCode = '${{ steps.link-check.outputs.exit_code }}';
          const status = exitCode === '0' ? '✅ Passed' : '❌ Failed';
          
          const body = `## Link Validation ${status}
          
          <details>
          <summary>Click to expand full report</summary>
          
          ${linkReport}
          
          </details>
          
          ---
          *This comment was automatically generated by the documentation validation workflow.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: Fail if links are broken
      if: steps.link-check.outputs.exit_code != '0'
      run: |
        echo "::error::Broken links detected in documentation. See the link validation report for details."
        exit 1

  example-validation:
    name: Validate Examples
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install uv
      uses: astral-sh/setup-uv@v3
      
    - name: Install dependencies
      run: uv sync
      
    - name: Run example validation
      id: example-check
      run: |
        uv run python scripts/run_examples.py --format markdown --output example-report.md --verbose
        exit_code=$?
        echo "exit_code=$exit_code" >> $GITHUB_OUTPUT
        exit $exit_code
      continue-on-error: true
      
    - name: Upload example validation report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: example-validation-report-${{ github.run_number }}
        path: example-report.md
        retention-days: 30
        
    - name: Comment PR with example validation results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          let exampleReport = '';
          try {
            exampleReport = fs.readFileSync('example-report.md', 'utf8');
          } catch (error) {
            exampleReport = 'Example validation report not available';
          }
          
          const exitCode = '${{ steps.example-check.outputs.exit_code }}';
          const status = exitCode === '0' ? '✅ Passed' : '❌ Failed';
          
          const body = `## Example Validation ${status}
          
          <details>
          <summary>Click to expand full report</summary>
          
          ${exampleReport}
          
          </details>
          
          ---
          *This comment was automatically generated by the documentation validation workflow.*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
          
    - name: Fail if examples are broken
      if: steps.example-check.outputs.exit_code != '0'
      run: |
        echo "::error::Broken examples detected. See the example validation report for details."
        exit 1

  validation-summary:
    name: Documentation Validation Summary
    runs-on: ubuntu-latest
    needs: [link-validation, example-validation]
    if: always()
    
    steps:
    - name: Check validation results
      run: |
        link_result="${{ needs.link-validation.result }}"
        example_result="${{ needs.example-validation.result }}"
        
        echo "Link Validation: $link_result"
        echo "Example Validation: $example_result"
        
        if [ "$link_result" = "failure" ] || [ "$example_result" = "failure" ]; then
          echo "::error::Documentation validation failed. Please fix the issues before merging."
          exit 1
        fi
        
        echo "✅ All documentation validations passed!"
